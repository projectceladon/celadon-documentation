

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Run Celadon in a Docker* container &mdash; Documentation for the Celadon Project</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Release Naming Convention" href="naming-convention.html" />
    <link rel="prev" title="Run Celadon in a virtual machine" href="on-vm.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Celadon Project
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="getting-started.html">Getting Started</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="as-service.html">Run Project Celadon on Intel® architectures</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="on-vm.html">Run Celadon in a virtual machine</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Run Celadon in a Docker* container</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li class="toctree-l4"><a class="reference internal" href="#build-the-cic-package">Build the CiC Package</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deploy-on-target">Deploy on Target</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="naming-convention.html">Release Naming Convention</a></li>
<li class="toctree-l2"><a class="reference internal" href="build-source.html">Build Celadon From Source</a></li>
<li class="toctree-l2"><a class="reference internal" href="on-bm.html">Run Celadon on Intel Platforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="submit-patch.html">Submit your patches</a></li>
<li class="toctree-l2"><a class="reference internal" href="host-os-hardening.html">Host OS Hardening</a></li>
<li class="toctree-l2"><a class="reference internal" href="how-to.html">How do I …</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/tutorials.html">Guides and Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release-notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faqs.html">Frequently Asked Questions</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Celadon Project</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="getting-started.html">Getting Started</a> &raquo;</li>
        
          <li><a href="as-service.html">Run Project Celadon on Intel® architectures</a> &raquo;</li>
        
      <li>Run Celadon in a Docker* container</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/getting-started/on-container.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <section id="run-c-in-a-docker-container">
<span id="caas-on-container"></span><h1>Run Celadon in a Docker* container<a class="headerlink" href="#run-c-in-a-docker-container" title="Permalink to this headline">¶</a></h1>
<p>This page explains how to run the Celadon Android* image in a Docker*
container.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#description" id="id1">Description</a></p></li>
<li><p><a class="reference internal" href="#prerequisites" id="id2">Prerequisites</a></p></li>
<li><p><a class="reference internal" href="#build-the-cic-package" id="id3">Build the CiC Package</a></p></li>
<li><p><a class="reference internal" href="#deploy-on-target" id="id4">Deploy on Target</a></p></li>
</ul>
</div>
<section id="description">
<h2><a class="toc-backref" href="#id1">Description</a><a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h2>
<p><abbr title="Celadon in Container">CiC</abbr> is Intel’s open source Android solution
for running Celadon on a Linux based container environment, in order to achieve
high-scalability, low performance overhead for some emerging use cases
such as Cloud Gaming, IOT and <abbr title="Flexible Container Framework">FCF</abbr>.</p>
<p>To support CiC running multiple Android instances on a single kernel without
interfering each other, the following isolation approach is implemented:</p>
<blockquote>
<div><p><em class="dfn">I/O Devices</em></p>
<blockquote>
<div><p>I/O devices can be shared between different Android instances,
and mediation is required.</p>
</div></blockquote>
<p><em class="dfn">Kernel</em></p>
<blockquote>
<div><p>Shared resources consumed by the Android instances should be isolated.</p>
<blockquote>
<div><ul class="simple">
<li><p>CPU, Memory are isolated using CGroup.</p></li>
<li><p>Binder is isolated by adding multiple device nodes.</p></li>
</ul>
</div></blockquote>
</div></blockquote>
<p><em class="dfn">Usespace</em></p>
<blockquote>
<div><p>Resources in different Android instances need to be isolated,
for example, network/process id/… PID, process name, network, cgroup names, etc.</p>
</div></blockquote>
</div></blockquote>
<p>Running CiC requires modern PCs with 6th generation or newer Intel®
Architecture Processors with integrated GPU. The Intel NUC model <a class="reference external" href="https://www.intel.com/content/www/us/en/products/boards-kits/nuc/kits/nuc7i7bnh.html">NUC7i7BNH</a>
and model <a class="reference external" href="https://www.intel.com/content/www/us/en/products/boards-kits/nuc/kits/nuc7i5bnh.html">NUC7i5BNH</a> are recommended devices to try out the CiC features.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The current version of CiC is 0.5, which provides a preview of the feature
for pilot and development purposes. Some features such as <a class="reference external" href="https://source.android.com/security/trusty">Trusty</a>, <a class="reference external" href="https://source.android.com/security/verifiedboot">Verified Boot</a>,
and the <a class="reference external" href="https://source.android.com/devices/tech/ota">OTA update</a> do not exist in this preview version.
We plan for these features in upcoming releases.</p>
</div>
</section>
<section id="prerequisites">
<h2><a class="toc-backref" href="#id2">Prerequisites</a><a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<section id="set-up-security-enhanced-linux-selinux">
<h3>Set up Security-Enhanced Linux (SELinux)<a class="headerlink" href="#set-up-security-enhanced-linux-selinux" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>On the target device, CiC currently requires Ubuntu 18.04.3 or later
running <a class="reference external" href="https://selinuxproject.org">SELinux</a> module enabled Linux* kernel, Ubuntu 20.04 (Focal Fossa)
is recommended. Though SELinux module
may be enabled in the Ubuntu kernels by default, you have to hook
the module to the kernel through the Linux Security Module (LSM) framework.
The following command adds the required kernel command line option to
the configuration file template <code class="file docutils literal notranslate"><span class="pre">/etc/default/grub</span></code> of GRUB bootloader,
in order to hook the SELinux module to the kernel LSM framework.</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo vi /etc/default/grub
</pre></div>
</div>
</div></blockquote>
<p>Modify the <span class="guilabel">GRUB_CMDLINE_LINUX</span> setting as follows:</p>
<blockquote>
<div><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>...
GRUB_CMDLINE_LINUX=&quot;lsm=yama,loadpin,integrity,selinux&quot;
...
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Update the bootloader with the new setting and reboot the device
with the following commands:</p>
<blockquote>
<div><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo update-grub
Sourcing file `/etc/default/grub&#39;
Generating grub configuration file ...
...
Adding boot menu entry for EFI firmware configuration
Done
$ sudo reboot
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
</section>
<section id="set-up-docker-engine">
<h3>Set up Docker Engine<a class="headerlink" href="#set-up-docker-engine" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>You must install Docker on both the development host and the target
device. Enter the following commands to install the prerequisites, set up
the repository, and install the Docker Engine. Refer to the
<a class="reference external" href="https://docs.docker.com/install/linux/docker-ce/ubuntu/">Get Docker Engine - Community for Ubuntu</a> installation guide for more
detailed information.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo apt-get install apt-transport-https ca-certificates curl
$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg <span class="p">|</span> sudo apt-key add -
$ sudo add-apt-repository <span class="s2">&quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu </span><span class="k">$(</span>lsb_release -cs<span class="k">)</span><span class="s2"> stable&quot;</span>
$ sudo apt-get update
$ sudo apt-get install -y docker-ce docker-ce-cli containerd.io
$ sudo usermod -aG docker <span class="nv">$USER</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The last command is optional if you want to run the Docker as a non-root user.</p>
</div>
</li>
<li><p>Restart your session for changes to take effect.</p></li>
</ol>
</section>
</section>
<section id="build-the-cic-package">
<h2><a class="toc-backref" href="#id3">Build the CiC Package</a><a class="headerlink" href="#build-the-cic-package" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p>Refer to the <a class="reference internal" href="build-source.html#build-from-source"><span class="std std-ref">Build Celadon From Source</span></a> section in the Getting Started
Guide to set up the Celadon source tree and the build environment. There are
two build targets associated with the CiC builds:</p>
<p><strong class="makevar">cic</strong></p>
<blockquote>
<div><p>The lunch target which is Android CDD compliant.</p>
</div></blockquote>
<p><strong class="makevar">cic_dev</strong></p>
<blockquote>
<div><p>The lunch target for development purposes (available on the CiC branch of the Celadon
Android-P release). This lunch target is deprecated.</p>
</div></blockquote>
</li>
<li><p>Run the following commands to select <span class="guilabel">cic-userdebug</span> as the lunch
target and start the build. The CiC package is generated at
<code class="file docutils literal notranslate"><span class="pre">$OUT/$TARGET_PRODUCT-*.tar.gz</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">source</span> build/envsetup.sh
$ lunch cic-userdebug
$ make cic -j <span class="k">$(</span>nproc<span class="k">)</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="deploy-on-target">
<span id="deploy-cic-on-target"></span><h2><a class="toc-backref" href="#id4">Deploy on Target</a><a class="headerlink" href="#deploy-on-target" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p>Download and extract the CiC package tar file on the target device.</p></li>
<li><p>The CiC image supports <em>secure</em> mode and <em>non-secure</em> mode.
In <strong>secure</strong> mode, <a class="reference external" href="https://source.android.com/security/trusty">Trusty</a> is enabled and <a class="reference external" href="https://selinuxproject.org">SELinux</a> policy is set to
enforcing mode, thus you can’t modify the <em class="dfn">/system</em> partition,
update the docker container is not possible. In addition, since Trusty should
implement a secure storage service based on the <abbr title="Replay Protected Memory Block">RPMB</abbr>
partition in eMMC, the following step includes instructions on how to
set up a <em class="dfn">teedata</em> partition to simulate the RPMB secure storage.</p>
<p>In contrast, Trusty is disabled and SELinux policy is set to permissive mode
in <strong>non-secure</strong> mode. The container can be updated, and you can
modify the <em class="dfn">/system</em> partition as well.</p>
</li>
<li><p>Skip this step if you are setting up the CiC image in non-secure mode.</p>
<ol class="loweralpha">
<li><p>A ‘<em class="dfn">teedata</em>’ disk partition is required to run CiC in secure mode.
Create a new disk partition of 32M bytes in size with the name ‘<strong>teedata</strong>’
if there are unallocated disk space on the target device. You may reference
<a class="reference external" href="https://howtoubuntu.org/how-to-resize-partitions-with-the-ubuntu-or-gparted-live-cd">this article</a>
to shrink the root partition of an existing Ubuntu setup, if no disk space
can be reserved as the <em class="dfn">teedata</em> partition.</p>
<p>The following example boots the device from a Ubuntu live-CD, runs the <strong class="command">gparted</strong>
utility, right-clicks the root partition and selects <span class="guilabel">Resize/Move</span> item
to reserve 32MB disk space at the bottom of the root disk:</p>
<figure class="align-center">
<img alt="../_images/cic-shrink-root-partition.png" src="../_images/cic-shrink-root-partition.png" />
</figure>
</li>
<li><p>To create a ‘<em class="dfn">teedata</em>’ partition,
right-click the unallocated partition, select <span class="guilabel">New</span> item, create
a new partition named “’<em class="dfn">teedata</em>”, set its label to “’<em class="dfn">teedata</em>” as well,
and leave the File system “unformatted”:</p>
<figure class="align-center">
<img alt="../_images/cic-add-teedata-partition.png" src="../_images/cic-add-teedata-partition.png" />
</figure>
</li>
<li><p>The first disk partition used to be the EFI System Partition, please rename
it to “EFI” by right-clicking the partition, and select <span class="guilabel">Name Partition</span> item:</p>
<figure class="align-center">
<img alt="../_images/cic-rename-efi-partition.png" src="../_images/cic-rename-efi-partition.png" />
</figure>
</li>
<li><p>Finally, click <span class="guilabel">Edit</span> then <span class="guilabel">Apply All Operations</span> items
for changes to take effect.</p>
<figure class="align-center">
<img alt="../_images/cic-apply-parrtition-changes.png" src="../_images/cic-apply-parrtition-changes.png" />
</figure>
</li>
<li><p>Before rebooting the Ubuntu system, make sure the <span class="guilabel">Secure Boot</span> feature
is disabled in the UEFI firmware:</p>
<figure class="align-center">
<img alt="../_images/nuc7i5dnh-secure-boot-disabled.png" src="../_images/nuc7i5dnh-secure-boot-disabled.png" />
</figure>
</li>
</ol>
</li>
<li><p>Run the <code class="file docutils literal notranslate"><span class="pre">setup-aic</span></code> script to install the container images.
You can pass ‘<strong class="command">-s</strong>’ argument to the script to set up the containers
in secure mode, or ‘<strong class="command">-ns</strong>’ argument for non-secure mode.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To run CiC in secure mode, make sure you have ever set up a <em class="dfn">teedata</em>
partition for the <abbr title="Replay Protected Memory Block">RPMB</abbr> simulation.
Check out the previous step for detailed information.</p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># The following command sets up CiC in non-secure mode</span>
$ sudo -E ./setup-aic -ns
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># The following command sets up CiC in secure mode</span>
$ sudo -E ./setup-aic -s
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ol class="arabic">
<li><p>If you are setting up the CiC in secure mode, some of the Ubuntu startup
files in the <abbr title="EFI System Partition">ESP</abbr> are overwritten
by the <code class="file docutils literal notranslate"><span class="pre">setup-aic</span></code> script. Specifically, the bootloader shim file
<code class="file docutils literal notranslate"><span class="pre">shimx64.efi</span></code> is replaced by <code class="file docutils literal notranslate"><span class="pre">kf4cic.efi</span></code> in the CiC package.
The original shim file is renamed as <code class="file docutils literal notranslate"><span class="pre">loaderx64.efi</span></code>.
In addition, the <code class="file docutils literal notranslate"><span class="pre">tos.img</span></code> image, which contains the Trusty OS,
is copied to the ESP partition as well.</p></li>
<li><p>Since the Ubuntu booting sequence has been extended to run the Trusty OS,
you would see the following warning during the system startup as the secure
boot is disabled:</p>
<figure class="align-center">
<img alt="../_images/cic-boot-warning.jpg" src="../_images/cic-boot-warning.jpg" />
</figure>
</li>
</ol>
</div>
</li>
<li><p>Reboot the device after the installation.</p></li>
<li><p>The <code class="file docutils literal notranslate"><span class="pre">setup-aic</span></code> script not only set up CiC docker images on the target
device, but also installed a <a class="reference external" href="https://www.freedesktop.org/wiki/Software/systemd/">systemd</a> service ‘<strong class="command">cic</strong>’ to launch the CiC
container images automatically on system startup. You can verify whether the CiC
containers are running successfully with the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo docker ps
CONTAINER ID        IMAGE                                 COMMAND                  CREATED             STATUS              PORTS                    NAMES
b5186e3c2116        android:CC0000105-cic-userdebug       <span class="s2">&quot;/android-entry -e 0&quot;</span>    <span class="m">5</span> minutes ago       Up <span class="m">2</span> minutes        <span class="m">0</span>.0.0.0:5555-&gt;5555/tcp   android0
f077a4eb722c        aic-manager:CC0000105-cic-userdebug   <span class="s2">&quot;/aic-manager-entry ...&quot;</span> <span class="m">5</span> minutes ago       Up <span class="m">2</span> minutes                                 aic-manager
</pre></div>
</div>
</li>
<li><p>In addition, an Android Container Client for Linux script ‘<strong class="command">cfc</strong>’
and its desktop file <span class="guilabel">cfc.desktop</span> are also installed on the Gnome desktop.
Run the <strong class="command">cfc</strong> script in a shell terminal or launch the <span class="guilabel">cfc.desktop</span>
from the GUI, a full screen window pops up and shows the Android home screen:</p>
<figure class="align-center">
<img alt="../_images/cic-start.png" src="../_images/cic-start.png" />
</figure>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>CiC runs as a Docker container, as a result, you can use
<a class="reference external" href="https://docs.docker.com/engine/reference/commandline/cli">Docker CLI commands</a> directly for debugging. For example, if you
encounter issues, you can capture necessary information by running the
following commands:</p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ docker logs aic-manager <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> tee aic-manager.log
$ docker <span class="nb">exec</span> -it android0 sh <span class="p">|</span> tee android.log
<span class="c1"># run commands to get information, such as</span>
     getprop
     logcat -b all
</pre></div>
</div>
</li>
</ol>
</section>
</section>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="naming-convention.html" class="btn btn-neutral float-right" title="Release Naming Convention" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="on-vm.html" class="btn btn-neutral" title="Run Celadon in a virtual machine" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, BSD, MIT, Apache and GPL licenses.
      Last updated on Sep 08, 2021.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 

</body>
</html>