

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Run Celadon in a virtual machine &mdash; Documentation for the Celadon Project</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Release Naming Convention" href="naming-convention.html" />
    <link rel="prev" title="Run Project Celadon on Intel® architectures" href="as-service.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Celadon Project
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="getting-started.html">Getting Started</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="as-service.html">Run Project Celadon on Intel® architectures</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Run Celadon in a virtual machine</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li class="toctree-l4"><a class="reference internal" href="#intel-gvt-d-overview">Intel GVT-d overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#intel-gpu-sr-iov-overview">Intel GPU SR-IOV overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#prepare-the-host-environment">Prepare the host environment</a></li>
<li class="toctree-l4"><a class="reference internal" href="#build-c-images-running-in-vm">Build Celadon images running in VM</a></li>
<li class="toctree-l4"><a class="reference internal" href="#create-a-civ-virtual-disk">Create a CiV virtual disk</a></li>
<li class="toctree-l4"><a class="reference internal" href="#boot-to-android-ui">Boot to Android UI</a></li>
<li class="toctree-l4"><a class="reference internal" href="#launching-with-sd-card">Launching with SD card</a></li>
<li class="toctree-l4"><a class="reference internal" href="#audio-pass-through-option">Audio pass-through option</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="naming-convention.html">Release Naming Convention</a></li>
<li class="toctree-l2"><a class="reference internal" href="build-source.html">Build Celadon From Source</a></li>
<li class="toctree-l2"><a class="reference internal" href="on-bm.html">Run Celadon on Intel Platforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="submit-patch.html">Submit your patches</a></li>
<li class="toctree-l2"><a class="reference internal" href="host-os-hardening.html">Host OS Hardening</a></li>
<li class="toctree-l2"><a class="reference internal" href="how-to.html">How do I …</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/tutorials.html">Guides and Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stable-release_iot/stable-release_iot.html">Stable Releases IoT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release-notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faqs.html">Frequently Asked Questions</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Celadon Project</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="getting-started.html">Getting Started</a> &raquo;</li>
        
          <li><a href="as-service.html">Run Project Celadon on Intel® architectures</a> &raquo;</li>
        
      <li>Run Celadon in a virtual machine</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/getting-started/on-vm.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="run-c-in-a-virtual-machine">
<span id="caas-on-vm"></span><h1>Run Celadon in a virtual machine</h1>
<p>This page explains what you’ll need to run Celadon in a virtual machine.</p>
<p>Depending on your applications, you can run <abbr title="Celadon in VM">CiV</abbr> using
Intel® GVT-g technology, or allowing for GPU passthrough to a single
Android* guest VM through Intel® Virtualization Technology (Intel® VT) for
Directed I/O (Intel® VT-d) technology, or SR-IOV (single root input/output
virtualization) Intel VT to have a balance of GPU sharing
(for multiple VMs) and performance as good as bare metal, VirtIO GPU,
or pure software rendering.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#prerequisites" id="id1">Prerequisites</a></li>
<li><a class="reference internal" href="#intel-gvt-d-overview" id="id2">Intel GVT-d overview</a></li>
<li><a class="reference internal" href="#intel-gpu-sr-iov-overview" id="id3">Intel GPU SR-IOV overview</a></li>
<li><a class="reference internal" href="#prepare-the-host-environment" id="id4">Prepare the host environment</a><ul>
<li><a class="reference internal" href="#set-up-qemu-and-intel-gvt-sr-iov-technology" id="id5">Set up QEMU and Intel GVT/SR-IOV technology</a></li>
<li><a class="reference internal" href="#use-c-kernel" id="id6">Use Celadon kernel</a></li>
</ul>
</li>
<li><a class="reference internal" href="#build-c-images-running-in-vm" id="id7">Build Celadon images running in VM</a></li>
<li><a class="reference internal" href="#create-a-civ-virtual-disk" id="id8">Create a CiV virtual disk</a></li>
<li><a class="reference internal" href="#boot-to-android-ui" id="id9">Boot to Android UI</a><ul>
<li><a class="reference internal" href="#use-vm-manager" id="id10">Use vm-manager</a></li>
<li><a class="reference internal" href="#use-start-civ-sh" id="id11">Use start_civ.sh</a></li>
<li><a class="reference internal" href="#intel-gvt-option" id="id12">Intel GVT option</a></li>
<li><a class="reference internal" href="#usb-pci-controller-pass-through-option" id="id13">USB PCI controller pass-through option</a></li>
</ul>
</li>
<li><a class="reference internal" href="#launching-with-sd-card" id="id14">Launching with SD card</a></li>
<li><a class="reference internal" href="#audio-pass-through-option" id="id15">Audio pass-through option</a></li>
</ul>
</div>
<div class="section" id="prerequisites">
<h2><a class="toc-backref" href="#id1">Prerequisites</a></h2>
<ul>
<li><p class="first">An Intel® NUC with an eighth generation (12th generation for SR-IOV) or newer Intel® Core™ Processor.</p>
</li>
<li><p class="first">Ubuntu* 20.04 (Focal Fossa) preinstalled that runs Linux* kernel
version 5.0.0 (5.10.100 for SR-IOV) or above.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><abbr title="Celadon in VM">CiV</abbr> releases have been validated on
Intel NUC model <a class="reference external" href="https://www.intel.com/content/www/us/en/products/boards-kits/nuc/kits/nuc7i5dnhe.html">NUC7i5DNHE</a>. Releases after <strong>April 17th 2020</strong> are
validated on Intel NUC model <a class="reference external" href="https://www.intel.com/content/www/us/en/products/boards-kits/nuc/kits/nuc10i7fnk.html">NUC10i7FNK</a> and <a class="reference external" href="https://www.intel.com/content/www/us/en/products/boards-kits/nuc/kits/nuc10i7fnh.html">NUC10i7FNH</a> to
take performance advantages of 10th Generation Intel Core Processors.
For SR-IOV, they are validated on Intel NUC model NUC12WSH with 12th generation
Intel Core Processors.</p>
</div>
</li>
</ul>
</div>
<div class="section" id="intel-gvt-d-overview">
<h2><a class="toc-backref" href="#id2">Intel GVT-d overview</a></h2>
<p>Intel® Graphics Virtualization Technology (Intel® GVT) covers three distinct
flavors of graphics virtualization approaches. Among these approaches,
Intel GVT-d is based on Intel VT-d
technology, it also includes additional graphics related configuration
options when compared to standard NIC pass-through devices.
Intel GVT-d allows direct assignment of an entire GPU’s capacity to
a single user, passing the native driver capabilities through the hypervisor
without limitations.</p>
<p>Refer to this <a class="reference external" href="https://01.org/sites/default/files/downloads/igvt-g/gvtflyer.pdf">article</a>
for an introduction to Intel Graphics Virtualization Technology.</p>
</div>
<div class="section" id="intel-gpu-sr-iov-overview">
<h2><a class="toc-backref" href="#id3">Intel GPU SR-IOV overview</a></h2>
<p>An Intel GPU can isolate GPU PCIe devices to improve performance to a level that is similar to bare-metal levels. Intel GPU SR-IOV is based on SR-IOV technology, SR-IOV consists of two basic units: PF (Physical Function), which supports SR-IOV PCIe extended capability and manages entire physical devices; and VF (Virtual Function), a “lightweight” PCIe function that is a passthrough device for VMs.</p>
<p>Refer to <a class="reference external" href="https://projectacrn.github.io/latest/tutorials/sriov_virtualization.html">this article</a> and <a class="reference external" href="https://videoportal.intel.com/media/GPU+VirtualizationA+SRIOV+and+Beyond/0_2a3dmpu0">this video</a>
for an introduction to SR-IOV Technology.</p>
</div>
<div class="section" id="prepare-the-host-environment">
<h2><a class="toc-backref" href="#id4">Prepare the host environment</a></h2>
<div class="section" id="set-up-qemu-and-intel-gvt-sr-iov-technology">
<h3><a class="toc-backref" href="#id5">Set up QEMU and Intel GVT/SR-IOV technology</a></h3>
<p>The host device that launches the virtual machine requires Ubuntu 20.04.
To simplify the preparation work, a helper script <code class="file docutils literal"><span class="pre">setup_host.sh</span></code> is
provided. The script re-builds the <code class="file docutils literal"><span class="pre">OVMF.fd</span></code> firmware and
<a class="reference external" href="https://www.qemu.org/">QEMU</a> emulator from source depending on the target graphics virtualization
technology, and installs the required software on the installed Ubuntu
system for running Celadon in a VM with QEMU.</p>
<p>Download and extract the release
package(<cite>caas-releasefiles-&lt;$buildvariant&gt;.tar.gz</cite>)
from: <a class="reference external" href="https://github.com/projectceladon/celadon-binary">celadon-binary</a>
Meanwhile, you can also refer to <a class="reference internal" href="build-source.html#build-os-image"><span class="std std-ref">Build Celadon in VM image</span></a> section to build
release packages.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ sudo mkdir -p /opt/civ-1 <span class="o">&amp;&amp;</span> sudo chown -R <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> /opt/civ-1
$ tar zxvf caas-releasefiles-&lt;<span class="nv">$buildvariant</span>&gt;.tar.gz
$ chmod +x scripts/setup_host.sh
</pre></div>
</div>
<p>Launch the script with no argument to set up the environment for running
CiV using Intel GVT/SR-IOV technology:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ sudo -E ./scripts/setup_host.sh
</pre></div>
</div>
<p>During the installation, you will be prompted by some questions to
confirm the changes to the packages, it’s safe to respond <code class="kbd docutils literal"><span class="pre">y</span></code> to all of
them.</p>
</div>
<div class="section" id="use-c-kernel">
<h3><a class="toc-backref" href="#id6">Use Celadon kernel</a></h3>
<p>The Linux kernel is extremely important on every Android device. Google*
recommends using <a class="reference external" href="https://source.android.com/devices/architecture/kernel/android-common">AOSP common kernels</a> on Android devices to include
features and implementations required by Android.
In addition to the AOSP common kernel, Celadon also integrates several
<a class="reference external" href="https://github.com/projectceladon/vendor-intel-utils/tree/master/host/kernel/lts2019-chromium">staging patches</a>
to take advantages of high performance new Intel processors,
so it’s strongly recommended to run the Celadon kernel as the host OS,
especially running CiV on <a class="reference external" href="https://www.intel.com/content/www/us/en/products/boards-kits/nuc/kits/nuc10i7fnk.html">NUC10i7FNK</a> or <a class="reference external" href="https://www.intel.com/content/www/us/en/products/boards-kits/nuc/kits/nuc10i7fnh.html">NUC10i7FNH</a> (NUC12WSH for SR-IOV) Intel NUC devices.
To that end, a helper script <code class="file docutils literal"><span class="pre">build.sh</span></code> is designed to facilitate
building and deploying the Celadon kernel on an Ubuntu host.
Refer to the
<a class="reference external" href="https://github.com/projectceladon/vendor-intel-utils/blob/master/host/kernel/lts2020-chromium/README">README</a>
for detailed GVT kernel build instructions. Refer to
<a class="reference external" href="https://github.com/projectceladon/vendor-intel-utils/blob/master/host/kernel/lts2020-yocto/README">this README</a>
for detailed SR-IOV kernel build instructions.</p>
</div>
</div>
<div class="section" id="build-c-images-running-in-vm">
<h2><a class="toc-backref" href="#id7">Build Celadon images running in VM</a></h2>
<p>Refer to the <a class="reference internal" href="build-source.html#build-os-image"><span class="std std-ref">Build Celadon in VM image</span></a> section in the Getting Started Guide and
specify <span class="target" id="index-0"></span><code class="xref std std-envvar docutils literal"><span class="pre">caas</span></code> as the lunch target to build the CiV images. The
following CiV image types are generated at the end of the build:</p>
<p><code class="file docutils literal"><span class="pre">caas.img</span></code></p>
<p>The GPT disk image for direct booting. Skip the next section to
boot the CiV image with QEMU.</p>
<p><code class="file docutils literal"><span class="pre">caas-flashfiles-eng.&lt;user&gt;.zip</span></code></p>
<p>The compressed <em>flashfiles</em> package contains the Celadon partition images for
running in a VM. Proceed with the following section to install these
images to a virtual disk image in
<a class="reference external" href="https://www.linux-kvm.org/page/Qcow2">qcow2</a> format.</p>
<p><code class="file docutils literal"><span class="pre">caas-releasefiles-&lt;$buildvariant&gt;.tar.gz</span></code></p>
<p>The release tar ball contains all required flashfiles/scrips for running
Celadon in VM.</p>
</div>
<div class="section" id="create-a-civ-virtual-disk">
<h2><a class="toc-backref" href="#id8">Create a CiV virtual disk</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Skip this section if you plan to boot the device directly with the
GPT disk image <code class="file docutils literal"><span class="pre">caas.img</span></code>.</p>
</div>
<p>Follow the instructions below to create and set up CiV partitions on
a <em>qcow2</em> formatted virtual disk.</p>
<ol class="arabic">
<li><p class="first">Run the helper script <code class="file docutils literal"><span class="pre">start_flash_usb.sh</span></code>.</p>
<blockquote>
<div><div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> /opt/civ-1
$ sudo ./scripts/start_flash_usb.sh caas-flashfiles-eng.&lt;user&gt;.zip
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">By running the <code class="file docutils literal"><span class="pre">start_flash_usb.sh</span></code> script, a QEMU window will pop
up, it will drop to the built-in UEFI Shell, and start flashing the
partitions to the virtual disk image.</p>
<blockquote>
<div><div class="figure align-center">
<img alt="../_images/qemu-bios-flashing.png" src="../_images/qemu-bios-flashing.png" />
</div>
</div></blockquote>
</li>
<li><p class="first">The QEMU window will be closed automatically once flashing is complete.
Now we get the CiV virtual disk <code class="file docutils literal"><span class="pre">android.qcow2</span></code> under the current
directory.</p>
</li>
</ol>
</div>
<div class="section" id="boot-to-android-ui">
<h2><a class="toc-backref" href="#id9">Boot to Android UI</a></h2>
<p>There are two ways to start a CiV instance:
<cite>vm-manager</cite> and <cite>start_civ.sh</cite>.
For Android-12 and later releases, please refer to
<a class="reference external" href="#use-vm-manager">vm-manger</a>.
For Android-11 and previous releases, please refer to
<a class="reference external" href="#use-start-civ-sh">start_civ.sh</a>.
Check Release Notes here: <a class="reference external" href="https://docs.01.org/celadon/release-notes.html">https://docs.01.org/celadon/release-notes.html</a>.</p>
<div class="section" id="use-vm-manager">
<h3><a class="toc-backref" href="#id10">Use vm-manager</a></h3>
<p>The <cite>vm-manager</cite> tool was developed to facilitate the CiV images
booting process. It supports various options:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>vm-manager <span class="o">[</span>-c<span class="o">]</span> <span class="o">[</span>-i config_file_path<span class="o">]</span> <span class="o">[</span>-d vm_name<span class="o">]</span> <span class="o">[</span>-b vm_name<span class="o">]</span> <span class="o">[</span>-q vm_name<span class="o">]</span> <span class="o">[</span>-f vm_name<span class="o">]</span> <span class="o">[</span>-m vm_name<span class="o">]</span> <span class="o">[</span>-l<span class="o">]</span> <span class="o">[</span>-v<span class="o">]</span> <span class="o">[</span>-h<span class="o">]</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="31%" />
<col width="69%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><code class="kbd docutils literal"><span class="pre">-c</span></code></td>
<td>Create a new CiV guest configuration</td>
</tr>
<tr class="row-even"><td><code class="kbd docutils literal"><span class="pre">-i</span></code></td>
<td>Import a CiV guest from existing config file</td>
</tr>
<tr class="row-odd"><td><code class="kbd docutils literal"><span class="pre">-d</span></code></td>
<td>Delete a CiV guest</td>
</tr>
<tr class="row-even"><td><code class="kbd docutils literal"><span class="pre">-b</span></code></td>
<td>Start a CiV guest</td>
</tr>
<tr class="row-odd"><td><code class="kbd docutils literal"><span class="pre">-q</span></code></td>
<td>Stop a CiV guest</td>
</tr>
<tr class="row-even"><td><code class="kbd docutils literal"><span class="pre">-f</span></code></td>
<td>Flash a CiV guest</td>
</tr>
<tr class="row-odd"><td><code class="kbd docutils literal"><span class="pre">-u</span></code></td>
<td>Update an existing CiV guest</td>
</tr>
<tr class="row-even"><td><code class="kbd docutils literal"><span class="pre">-l</span></code></td>
<td>List existing CiV guest</td>
</tr>
<tr class="row-odd"><td><code class="kbd docutils literal"><span class="pre">-v</span></code></td>
<td>Show CiV vm-manager version</td>
</tr>
<tr class="row-even"><td><code class="kbd docutils literal"><span class="pre">-h</span></code></td>
<td>Show this help message</td>
</tr>
</tbody>
</table>
<p>All CiV guest configuration file (INI formated) are stored at
<code class="file docutils literal"><span class="pre">$HOME/.intel/.civ/</span></code>,</p>
<ol class="arabic">
<li><p class="first">Install vm-manager
Download the latest release package from: <a class="reference external" href="https://github.com/projectceladon/vm_manager/releases">https://github.com/projectceladon/vm_manager/releases</a>.
Install it with this command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sudo apt-get install ./vm-manager_vx.y.z_<span class="nv">$OS_VER</span>.deb
</pre></div>
</div>
</li>
<li><p class="first">Create a ini file under <code class="file docutils literal"><span class="pre">$HOME/.intel/.civ/civ-1.ini</span></code> for GVT-g. Configure it
as shown below:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="k">global</span><span class="p">]</span>
<span class="n">name</span><span class="o">=</span><span class="n">civ</span><span class="o">-</span><span class="mi">1</span>
<span class="n">flashfiles</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">civ</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">caas</span><span class="o">-</span><span class="n">flashfiles</span><span class="o">-</span><span class="n">CR0000317</span><span class="o">.</span><span class="n">zip</span>
<span class="n">adb_port</span><span class="o">=</span><span class="mi">5555</span>
<span class="n">fastboot_port</span><span class="o">=</span><span class="mi">5554</span>

<span class="p">[</span><span class="n">emulator</span><span class="p">]</span>
<span class="n">path</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">x86_64</span>

<span class="p">[</span><span class="n">memory</span><span class="p">]</span>
<span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="n">G</span>

<span class="p">[</span><span class="n">vcpu</span><span class="p">]</span>
<span class="n">num</span><span class="o">=</span><span class="mi">1</span>

<span class="p">[</span><span class="n">firmware</span><span class="p">]</span>
<span class="nb">type</span><span class="o">=</span><span class="n">unified</span>
<span class="n">path</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">civ</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">OVMF</span><span class="o">.</span><span class="n">fd</span>

<span class="p">[</span><span class="n">disk</span><span class="p">]</span>
<span class="n">size</span><span class="o">=</span><span class="mi">30</span><span class="n">G</span>
<span class="n">path</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">civ</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">android</span><span class="o">.</span><span class="n">qcow2</span>

<span class="p">[</span><span class="n">graphics</span><span class="p">]</span>
<span class="nb">type</span><span class="o">=</span><span class="n">GVT</span><span class="o">-</span><span class="n">g</span>
<span class="n">gvtg_version</span><span class="o">=</span><span class="n">i915</span><span class="o">-</span><span class="n">GVTg_V5_4</span>
<span class="n">vgpu_uuid</span><span class="o">=</span><span class="mi">1</span><span class="n">fc89c23</span><span class="o">-</span><span class="n">e8a6</span><span class="o">-</span><span class="mi">47</span><span class="n">a9</span><span class="o">-</span><span class="mi">83</span><span class="n">be</span><span class="o">-</span><span class="n">ec23d6f4bb17</span>

<span class="p">[</span><span class="n">vtpm</span><span class="p">]</span>
<span class="n">bin_path</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">swtpm</span>
<span class="n">data_dir</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">civ</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">vtpm0</span>

<span class="p">[</span><span class="n">rpmb</span><span class="p">]</span>
<span class="n">bin_path</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">civ</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">rpmb_dev</span>
<span class="n">data_dir</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">civ</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span>

<span class="p">[</span><span class="n">aaf</span><span class="p">]</span>
<span class="n">path</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">civ</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">aaf</span>

<span class="p">[</span><span class="n">extra</span><span class="p">]</span>
<span class="n">cmd</span><span class="o">=-</span><span class="n">chardev</span> <span class="n">socket</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="n">ch0</span><span class="p">,</span><span class="n">path</span><span class="o">=/</span><span class="n">tmp</span><span class="o">/</span><span class="n">civ1</span><span class="o">-</span><span class="n">console</span><span class="p">,</span><span class="n">server</span><span class="p">,</span><span class="n">nowait</span><span class="p">,</span><span class="n">logfile</span><span class="o">=/</span><span class="n">tmp</span><span class="o">/</span><span class="n">civ1_serial</span><span class="o">.</span><span class="n">log</span> <span class="o">-</span><span class="n">serial</span> <span class="n">chardev</span><span class="p">:</span><span class="n">ch0</span>
</pre></div>
</div>
</li>
<li><p class="first">Create an ini file under <code class="file docutils literal"><span class="pre">$HOME/.intel/.civ/civ-2.ini</span></code> for SR-IOV.
Configure it as shown below:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="k">global</span><span class="p">]</span>
<span class="n">name</span><span class="o">=</span><span class="n">civ</span><span class="o">-</span><span class="mi">2</span>
<span class="n">flashfiles</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">adl</span><span class="o">/</span><span class="n">sriov</span><span class="o">/</span><span class="n">caas</span><span class="o">-</span><span class="n">flashfiles</span><span class="o">-</span><span class="n">CRe011142</span><span class="o">-</span><span class="n">r1</span><span class="o">.</span><span class="n">zip</span>
<span class="n">adb_port</span><span class="o">=</span><span class="mi">5555</span>
<span class="n">fastboot_port</span><span class="o">=</span><span class="mi">5554</span>

<span class="p">[</span><span class="n">emulator</span><span class="p">]</span>
<span class="n">path</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">x86_64</span>

<span class="p">[</span><span class="n">memory</span><span class="p">]</span>
<span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="n">G</span>

<span class="p">[</span><span class="n">vcpu</span><span class="p">]</span>
<span class="n">num</span><span class="o">=</span><span class="mi">1</span>

<span class="p">[</span><span class="n">firmware</span><span class="p">]</span>
<span class="nb">type</span><span class="o">=</span><span class="n">unified</span>
<span class="n">path</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">adl</span><span class="o">/</span><span class="n">caas1</span><span class="o">/</span><span class="n">OVMF</span><span class="o">.</span><span class="n">fd</span>

<span class="p">[</span><span class="n">disk</span><span class="p">]</span>
<span class="n">size</span><span class="o">=</span><span class="mi">30</span><span class="n">G</span>
<span class="n">path</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">adl</span><span class="o">/</span><span class="n">caas1</span><span class="o">/</span><span class="n">android</span><span class="o">.</span><span class="n">qcow2</span>

<span class="p">[</span><span class="n">graphics</span><span class="p">]</span>
<span class="nb">type</span><span class="o">=</span><span class="n">SRIOV</span>

<span class="p">[</span><span class="n">vtpm</span><span class="p">]</span>
<span class="n">bin_path</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">swtpm</span>
<span class="n">data_dir</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">adl</span><span class="o">/</span><span class="n">caas1</span><span class="o">/</span><span class="n">vtpm0</span>

<span class="p">[</span><span class="n">rpmb</span><span class="p">]</span>
<span class="n">bin_path</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">adl</span><span class="o">/</span><span class="n">sriov</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">rpmb_dev</span>
<span class="n">data_dir</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">adl</span><span class="o">/</span><span class="n">caas1</span>

<span class="p">[</span><span class="n">aaf</span><span class="p">]</span>
<span class="n">path</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">adl</span><span class="o">/</span><span class="n">caas1</span><span class="o">/</span><span class="n">aaf</span>

<span class="p">[</span><span class="n">extra</span><span class="p">]</span>
<span class="n">cmd</span><span class="o">=-</span><span class="n">monitor</span> <span class="n">stdio</span>
</pre></div>
</div>
</li>
<li><dl class="first docutils">
<dt>Start the instance:</dt>
<dd><dl class="first last docutils">
<dt>for GVT-g:</dt>
<dd><div class="first last highlight-bash"><div class="highlight"><pre><span></span>$ sudo vm-manager -b civ-1
</pre></div>
</div>
</dd>
<dt>for SR-IOV:</dt>
<dd><div class="first last highlight-bash"><div class="highlight"><pre><span></span>$ sudo vm-manager -b civ-2
</pre></div>
</div>
</dd>
</dl>
</dd>
</dl>
</li>
</ol>
<p>For more details, please reference the following wiki to get started:
<a class="reference external" href="https://github.com/projectceladon/vm_manager/wiki/User-Guide">CiV VM Manager User Guide</a>.</p>
</div>
<div class="section" id="use-start-civ-sh">
<h3><a class="toc-backref" href="#id11">Use start_civ.sh</a></h3>
<p>The <cite>start_civ.sh</cite> script was developed to facilitate the CiV images
booting process. It supports the following options:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>start_civ.sh <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>-m<span class="o">]</span> <span class="o">[</span>-c<span class="o">]</span> <span class="o">[</span>-g<span class="o">]</span> <span class="o">[</span>-d<span class="o">]</span> <span class="o">[</span>-f<span class="o">]</span> <span class="o">[</span>-v<span class="o">]</span> <span class="o">[</span>-s<span class="o">]</span> <span class="o">[</span>-p<span class="o">]</span> <span class="o">[</span>-b<span class="o">]</span> <span class="o">[</span>-e<span class="o">]</span> <span class="o">[</span>--passthrough-pci-usb<span class="o">]</span> <span class="o">[</span>--passthrough-pci-audio<span class="o">]</span> <span class="o">[</span>--passthrough-pci-eth<span class="o">]</span> <span class="o">[</span>--passthrough-wifi<span class="o">]</span> <span class="o">[</span>--thermal-mediation<span class="o">]</span> <span class="o">[</span>--battery-mediation<span class="o">]</span> <span class="o">[</span>--guest-pm-control<span class="o">]</span> <span class="o">[</span>--guest-time-keep<span class="o">]</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="31%" />
<col width="69%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><code class="kbd docutils literal"><span class="pre">-h</span></code></td>
<td>show this help message.</td>
</tr>
<tr class="row-even"><td><code class="kbd docutils literal"><span class="pre">-m</span></code></td>
<td>specify guest memory size, eg. “-m 4G”. Default is 2G if this is not specified.</td>
</tr>
<tr class="row-odd"><td><code class="kbd docutils literal"><span class="pre">-c</span></code></td>
<td>specify guest cpu number, eg. “-c 4”. Default is 1 if this is not specified.</td>
</tr>
<tr class="row-even"><td><code class="kbd docutils literal"><span class="pre">-g</span></code></td>
<td><p class="first">specify guest graphics mode, current support <strong>VirtIO | GVT-g | GVT-d | QXL</strong>.</p>
<p>VirtIO GPU, eg. “-g VirtIO”</p>
<p>QXL VGA, eg. “-g QXL”</p>
<p>GVT-g, eg. “-g GVT-g,uuid=4ec1ff92-81d7-11e9-aed4-5bf6a9a2bb0a”, if uuid is not specified, a hardcoded uuid will be used</p>
<p>GVT-d: romfile is supported for GVT-d, eg. “-g GVT-d,romfile=/path/to/romfile”, romfile is optional.</p>
<p class="last">The default value is VirtIO if this parameter is not specified.</p>
</td>
</tr>
<tr class="row-odd"><td><code class="kbd docutils literal"><span class="pre">-d</span></code></td>
<td>specify guest virtual disk image, eg. “-d /path/to/android.img”. Default is “$PWD/android.qcow2” if this is not specified.</td>
</tr>
<tr class="row-even"><td><code class="kbd docutils literal"><span class="pre">-f</span></code></td>
<td>specify guest firmware image, eg. “-d /path/to/ovmf.fd”. Default is “$PWD/OVMF.fd” if this is not specified.</td>
</tr>
<tr class="row-odd"><td><code class="kbd docutils literal"><span class="pre">-v</span></code></td>
<td>specify guest vsock cid, eg. “-v 4”. Default is 3.</td>
</tr>
<tr class="row-even"><td><code class="kbd docutils literal"><span class="pre">-s</span></code></td>
<td>specify guest share folder path, eg. “-s /path/to/share/with/guest”.</td>
</tr>
<tr class="row-odd"><td><code class="kbd docutils literal"><span class="pre">-p</span></code></td>
<td>specify host forward ports, current support adb/fastboot, eg. “-p adb=6666,fastboot=7777”. Default is adb=5555,fastboot=5554</td>
</tr>
<tr class="row-even"><td><code class="kbd docutils literal"><span class="pre">-b</span></code></td>
<td>specify host block device as guest virtual device, eg.” -b /dev/mmcblk0 “</td>
</tr>
<tr class="row-odd"><td><code class="kbd docutils literal"><span class="pre">-e</span></code></td>
<td>specify extra qemu cmd, eg. “-e “-full-screen -monitor stdio”“</td>
</tr>
<tr class="row-even"><td><code class="kbd docutils literal"><span class="pre">--passthrough-pci-usb</span></code></td>
<td>passthrough USB PCI bus to guest.</td>
</tr>
<tr class="row-odd"><td><code class="kbd docutils literal"><span class="pre">--passthrough-pci-audio</span></code></td>
<td>passthrough Audio PCI bus to guest.</td>
</tr>
<tr class="row-even"><td><code class="kbd docutils literal"><span class="pre">--passthrough-pci-eth</span></code></td>
<td>passthrough Ethernet PCI bus to guest.</td>
</tr>
<tr class="row-odd"><td><code class="kbd docutils literal"><span class="pre">--passthrough-pci-wifi</span></code></td>
<td>passthrough WiFi PCI bus to guest.</td>
</tr>
<tr class="row-even"><td><code class="kbd docutils literal"><span class="pre">--thermal-mediation</span></code></td>
<td>enable thermal mediation.</td>
</tr>
<tr class="row-odd"><td><code class="kbd docutils literal"><span class="pre">--battery-mediation</span></code></td>
<td>enable battery mediation.</td>
</tr>
<tr class="row-even"><td><code class="kbd docutils literal"><span class="pre">--guest-pm-control</span></code></td>
<td>allow guest control host PM.</td>
</tr>
<tr class="row-odd"><td><code class="kbd docutils literal"><span class="pre">--guest-time-keep</span></code></td>
<td>reflect guest time setting on Host OS.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="intel-gvt-option">
<h3><a class="toc-backref" href="#id12">Intel GVT option</a></h3>
<p>Enter the following commands to run the script <cite>start_civ.sh</cite> with
root permissions to facilitate booting CiV images with QEMU.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> /opt/civ-1
<span class="c1"># The following command runs CiV using Intel GVT-g</span>
$ sudo -E ./scripts/start_civ.sh -g GVT-g
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># The following command runs CiV using Intel GVT-d, and passes</span>
<span class="c1"># all the attached USB devices such as keyboard, mouse to the VM.</span>
$ sudo -E ./scripts/start_civ.sh -g GVT-d --passthrough-pci-usb
</pre></div>
</div>
</div>
<div class="section" id="usb-pci-controller-pass-through-option">
<h3><a class="toc-backref" href="#id13">USB PCI controller pass-through option</a></h3>
<p>You can pass-through not only the GPU but also the USB host controller (xHCI)
to the Android VM to attach all the connected USB devices
(e.g. camera, USB thumb drive) to the VM.
By passing <strong class="command">--passthrough-pci-usb</strong> argument to the <cite>start_civ.sh</cite>
script, all the USB devices connected to the platform are automatically
enumerated inside the Android VM:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># The following command passes through the xHCI to the VM</span>
$ sudo -E ./scripts/start_civ.sh --passthrough-pci-usb
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">All the USB devices, including keyboard and mouse, will be disconnected
from the host OS and get attached to the Android VM.</p>
</div>
<p>An alternative methodology is to passthrough only selected USB devices
to the Android VM by modifying the <cite>start_civ.sh</cite> script.
For example, to pass-through the USB SD card reader in the following list,
whose vendorID and productID are <strong>14cd</strong> and <strong>125c</strong> respectively:</p>
<blockquote>
<div><div class="highlight-bash"><div class="highlight"><pre><span></span>$ lsusb
Bus <span class="m">004</span> Device <span class="m">001</span>: ID 1d6b:0003 Linux Foundation <span class="m">3</span>.0 root hub
Bus <span class="m">003</span> Device <span class="m">001</span>: ID 1d6b:0002 Linux Foundation <span class="m">2</span>.0 root hub
Bus <span class="m">001</span> Device <span class="m">003</span>: ID <span class="m">8087</span>:0a2b Intel Corp.
Bus <span class="m">001</span> Device <span class="m">005</span>: ID 093a:2510 Pixart Imaging, Inc. Optical Mouse
Bus <span class="m">001</span> Device <span class="m">004</span>: ID 1c4f:0002 SiGma Micro Keyboard TRACER Gamma Ivory
Bus <span class="m">001</span> Device <span class="m">008</span>: ID 14cd:125c Super Top SD card reader
</pre></div>
</div>
</div></blockquote>
<p>Execute <cite>start_civ.sh</cite> script as shown below, to enumerate the device
in the Android VM:</p>
<blockquote>
<div><div class="highlight-none"><div class="highlight"><pre><span></span>sudo -E ./scripts/start_civ.sh -e &quot;-device usb-host,vendroidid=0x14cd,productid=0x125c&quot;
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="launching-with-sd-card">
<h2><a class="toc-backref" href="#id14">Launching with SD card</a></h2>
<p>If your hardware platform supports SD cards through the <abbr title="Secure Digital Host Controller Interface">SDHCI</abbr> controller, you can enable
SDHCI mediation by adding <strong class="command">-b &lt;sdcard block device&gt;</strong> option
argument while invoking the <cite>start_civ.sh</cite> script if the SD card is present
in the slot.</p>
<p>With the following command, the SD card interface will be mediated to the
Android guest OS, and Android will mount the SD card on boot.
The external SD card mount is validated with the sdcardfs file system and the
mount point is available in the standard UI interfaces, such as file
explorer, storage settings etc.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ sudo -E ./scripts/start_civ.sh -b /dev/mmcblk0p1
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ol class="last arabic simple">
<li>This option should be given only if SD card is present in the slot.</li>
<li>Do not specify <strong class="command">--passthrough-pci-usb</strong> argument together
with the SD card options, or the SD card won’t be operational.</li>
</ol>
</div>
</div>
<div class="section" id="audio-pass-through-option">
<h2><a class="toc-backref" href="#id15">Audio pass-through option</a></h2>
<p>The audio controller can be passed through to the guest
by adding <strong class="command">--passthrough-pci-audio</strong> argument while invoking the
<cite>start_civ.sh</cite> script, the host then has no control over it.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ sudo -E ./scripts/start_civ.sh --passthrough-pci-audio
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>With the above setup, PCI controllers, which are part of the same IOMMU
group as the audio controller, will also be pass-through to the guest.
For example, if the Ethernet controller and the audio controller are
in the same IOMMU group, the Ethernet controller will be moved to the
guest. Thus if you are connecting to the host via Ethernet, the network
accesses to the host will be drop. Since the Android guest has accesses
to the Ethernet controller, you can connect to it using the following
command:</p>
<div class="last highlight-bash"><div class="highlight"><pre><span></span>$ adb connect &lt;guest-ip-addr&gt;:5555
</pre></div>
</div>
</div>
<div class="figure align-center">
<img alt="../_images/caas-qemu-booting.jpg" src="../_images/caas-qemu-booting.jpg" />
</div>
<div class="figure align-center">
<img alt="../_images/caas-qemu-lockscreen.jpg" src="../_images/caas-qemu-lockscreen.jpg" />
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="naming-convention.html" class="btn btn-neutral float-right" title="Release Naming Convention" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="as-service.html" class="btn btn-neutral" title="Run Project Celadon on Intel® architectures" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, BSD, MIT, Apache and GPL licenses.
      Last updated on Sep 19, 2022.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 

</body>
</html>