

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>User Guide &mdash; Documentation for the Celadon Project</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Release Notes" href="../release-notes.html" />
    <link rel="prev" title="Feature Delta Offered by Stable Releases (IoT)" href="feature-delta-iot.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Celadon Project
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting-started/getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/tutorials.html">Guides and Tutorials</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="stable-release_iot.html">Stable Releases IoT</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="feature-delta-iot.html">Feature Delta Offered by Stable Releases (IoT)</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">User Guide</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#system-requirements">System Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-to-install-this-release">How to install this release</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#celadon-build-steps">Celadon build steps</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#dut-setup">DUT setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#host-setup">Host setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#installing-ubuntu-host-kernel">Installing Ubuntu host kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-celadon-host-setup">Run Celadon host setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#guest-os-setup">Guest OS setup:</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#creating-celadon-guest-image">Creating Celadon guest image</a></li>
<li class="toctree-l4"><a class="reference internal" href="#launching-celadon-with-gvt-d">Launching Celadon with GVT-d</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#enable-keyboard-and-mouse">Enable keyboard and mouse</a></li>
<li class="toctree-l3"><a class="reference internal" href="#auto-starting-civ-using-gvt-d">Auto starting CiV (using GVT-d)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#supplementary-guide-for-power-and-volume-key-support">Supplementary guide for power and volume key support</a></li>
<li class="toctree-l3"><a class="reference internal" href="#acronyms-and-terms">Acronyms and terms</a></li>
<li class="toctree-l3"><a class="reference internal" href="#helpful-hints-related-documents">Helpful hints / related documents</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../release-notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faqs.html">Frequently Asked Questions</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Celadon Project</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="stable-release_iot.html">Stable Releases IoT</a> &raquo;</li>
        
      <li>User Guide</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/stable-release_iot/user-guide.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="user-guide">
<span id="id1"></span><h1>User Guide</h1>
<div class="section" id="system-requirements">
<h2>System Requirements</h2>
<p>Recommended system requirements for Host:</p>
<ul class="simple">
<li>CPU: 4 cores or more</li>
<li>RAM: 8 GB or more</li>
<li>Hard-Disk: 250 GB</li>
</ul>
</div>
<div class="section" id="how-to-install-this-release">
<h2>How to install this release</h2>
<div class="section" id="celadon-build-steps">
<h3>Celadon build steps</h3>
<p>Follow the development environment set up instructions in
<a class="reference external" href="https://docs.01.org/celadon/getting-started/build-source.html#set-up-the-development-environment">https://docs.01.org/celadon/getting-started/build-source.html#set-up-the-development-environment</a> for Celadon build host setup.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Install additional development package</span>
$ sudo apt install libjson-c-dev
</pre></div>
</div>
<p>Manifest Link: <a class="reference external" href="https://github.com/projectceladon/manifest/blob/master/stable-build/CIV_02.22.01.12_A11.xml">https://github.com/projectceladon/manifest/blob/master/stable-build/CIV_02.22.01.12_A11.xml</a></p>
<p>Steps to sync to this release:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Init with the default manifest</span>
$ repo init -u https://github.com/projectceladon/manifest.git

<span class="c1"># Copy the CIV manifest and use it</span>
$ cp &lt;<span class="nb">source</span> path&gt;/CIV_02.22.01.12_A11.xml .repo/manifests/
$ repo init -u https://github.com/projectceladon/manifest.git -m CIV_02.22.01.12_A11.xml
<span class="c1">#NOTE : Manifest tag will change according to the latest release</span>

<span class="c1"># Sync the code</span>
$ repo sync -c -q -j<span class="si">${</span><span class="nv">nproc</span><span class="si">}</span>
</pre></div>
</div>
<p>Step to generate the Android* Image:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>    <span class="c1"># Perform the environment setup from directory where repo is initialized</span>
    $ <span class="nb">source</span> build/envsetup.sh

    <span class="c1"># Select userdebug variant</span>
    $ lunch caas-userdebug

    <span class="c1"># Start the build</span>
    <span class="c1"># To enable avx optimizations for CML/EHL, BUILD_CPU_ARCH=kabylake could be</span>
    appended to the make command.
    <span class="c1"># Without this flag, default architecture is silvermont which exercises sse4.1 features.</span>
    $ make flashfiles -j <span class="k">$(</span>nproc<span class="k">)</span>


    <span class="c1"># Build output (CIV flashfiles)</span>
    $ find out/target/product/caas/ -name caas-flashfiles-*.zip
    out/target/product/caas/caas-flashfiles-xxxxx.zip

<span class="c1"># Ensure below host scripts and patches are available post build</span>

<span class="c1"># Host scripts</span>
    $ find out/target/product/caas/scripts -type d
    out/target/product/caas/scripts
    out/target/product/caas/scripts/sof_audio


    <span class="c1"># Host patches</span>
    $ find vendor/intel/utils/host -type d
    vendor/intel/utils/host
    vendor/intel/utils/host/ovmf
    vendor/intel/utils/host/qemu
    vendor/intel/utils/host/kernel
    vendor/intel/utils/host/kernel/lts2019-yocto
    vendor/intel/utils/host/kernel/lts2019-chromium
    vendor/intel/utils/host/lg
    $ find vendor/intel/utils_vertical/host -type d
    vendor/intel/utils_vertical/host
    vendor/intel/utils_vertical/host/qemu
</pre></div>
</div>
<p>Prerequisites and host kernel build steps:</p>
<p>Prerequisites</p>
<ul class="simple">
<li>Install Ubuntu* 18.04 LTS</li>
<li>If operating behind a corporate firewall, setup the proxy
settings</li>
<li>Install the following packages</li>
</ul>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ sudo apt install -y git fakeroot build-essential ncurses-dev xz-utils libssl-dev bc flex libelf-dev bison rsync kmod cpio
</pre></div>
</div>
<p>Host kernel build steps</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Sync kernel</span>
<span class="c1"># Note that this will pick up the latest on the branch</span>
$ git clone https://github.com/intel/linux-intel-lts.git -b <span class="m">5</span>.4/yocto

<span class="c1"># Change directory</span>
$ <span class="nb">cd</span> linux-intel-lts

<span class="c1"># Checkout to  specific commit (Refer to release notes for SHA ID)</span>
$ git checkout lts-v5.4.170-yocto-220124T222417Z

<span class="c1"># copy kernel config</span>
$ <span class="nb">cd</span> &lt;<span class="nb">source</span> path&gt;
$ wget https://github.com/projectceladon/vendor-intel-utils-vertical-iot/blob/main/x86_64_defconfig
$ cp x86_64_defconfig .config
$ <span class="nb">echo</span> <span class="s2">&quot;&quot;</span><span class="p">|</span> make <span class="nv">ARCH</span><span class="o">=</span>x86_64 olddefconfig

<span class="c1"># Make kernel debian package</span>
$ make <span class="nv">ARCH</span><span class="o">=</span>x86_64 -j16 <span class="nv">LOCALVERSION</span><span class="o">=</span>-lts2019-iotg bindeb-pkg

<span class="c1"># To find output files</span>
$ find .. -name <span class="s2">&quot;*.deb&quot;</span>
../linux-libc-dev_5.4.170-lts2019-iotg-1_amd64.deb
../linux-headers-5.4.170-lts2019-iotg_5.4.143-lts2019-iotg-1_amd64.deb
../linux-image-5.4.170-lts2019-iotg_5.4.143-lts2019-iotg-1_amd64.deb

<span class="c1"># Copy built .deb packages to use during Installing Ubuntu host kernel</span>
$ <span class="nb">cd</span> ..
$ cp *.deb &lt;target path&gt;
</pre></div>
</div>
</div>
</div>
<div class="section" id="dut-setup">
<h2>DUT setup</h2>
<p>Hardware details:</p>
<ul class="simple">
<li><dl class="first docutils">
<dt>HW Comet Lake (CML) NUC DUT details</dt>
<dd><ul class="first last">
<li>NUC10FNH Intel® Core™ i7-10710U CPU</li>
<li>BIOS Version FNCML357.0039.2020.0312.1734</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>HW Elkhart Lake (EHL) CRB DUT details</dt>
<dd><ul class="first last">
<li>For EHL A0 CRB, please ensure using BIOS version
EHLSFWI1.R00.2233.A07.2006180202 or later</li>
<li>For EHL Bx CRB, any BIOS version would do.</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>HW Tiger Lake (TGL) RVP DUT details</dt>
<dd><ul class="first last">
<li>TGL BX RVP</li>
<li>BIOS Version TGL1FUI1.R00.3412.A03.2010150719 and beyond</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>BIOS setting:</p>
<ul class="simple">
<li>Intel® Virtualization Technology (Intel® VT)<ul>
<li>Settings: Security -&gt; Security Features -&gt; Intel
Virtualization Technology: Enabled</li>
</ul>
</li>
<li>Intel® Virtualization Technology (Intel® VT) for
Directed I/O (Intel® VT-d) TBU<ul>
<li>Settings: Security -&gt; Security Features -&gt; Intel VT
for Directed I/O(VT-d): Enabled</li>
</ul>
</li>
<li><dl class="first docutils">
<dt>Secure Boot</dt>
<dd><ul class="first last">
<li>Boot -&gt; Secure Boot: Disabled</li>
</ul>
</dd>
</dl>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The menu structure may differ due to BIOS differences</p>
</div>
</div>
<div class="section" id="host-setup">
<h2>Host setup</h2>
<p>Prerequisites:</p>
<ul class="simple">
<li>Install Ubuntu 20.04 LTS</li>
<li>If operating behind a corporate firewall, setup the proxy settings</li>
<li>Disable Automatic suspend in host: Settings -&gt; Power -&gt; Suspend &amp;
Power Button -&gt; Automatic suspend -&gt; Off.</li>
</ul>
<p>Setup Ubuntu host:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Reboot into the Ubuntu host image</span>
    <span class="c1"># Change directory</span>
$ <span class="nb">cd</span> ~

<span class="c1"># Stop unattended upgrades services and edit /etc/apt/apt.conf.d/20auto-upgrades to as below.</span>
$ sudo systemctl stop unattended-upgrades.service
$ sudo systemctl disable unattended-upgrades.service
$ sudo systemctl mask unattended-upgrades.service
$ sudo vi /etc/apt/apt.conf.d/20auto-upgrades
APT::Periodic::Update-Package-Lists <span class="s2">&quot;0&quot;</span><span class="p">;</span>
APT::Periodic::Download-Upgradeable-Packages <span class="s2">&quot;0&quot;</span><span class="p">;</span>
APT::Periodic::AutocleanInterval <span class="s2">&quot;0&quot;</span><span class="p">;</span>
APT::Periodic::Unattended-Upgrade <span class="s2">&quot;0&quot;</span><span class="p">;</span>

<span class="c1"># Reboot the system</span>
$ sudo reboot now

<span class="c1"># Copy the artifact</span>
$ cp &lt;<span class="nb">source</span> path&gt;/caas-releasefiles-userdebug.tar.gz .

<span class="c1"># Extract files</span>
$ tar xzvf caas-releasefiles-userdebug.tar.gz
</pre></div>
</div>
</div>
<div class="section" id="installing-ubuntu-host-kernel">
<h2>Installing Ubuntu host kernel</h2>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Copy the deb files generated from build kernel instructions</span>
$ cp &lt;<span class="nb">source</span> path&gt;/*.deb .

<span class="c1"># Install the deb files</span>
$ sudo dpkg -i *.deb

<span class="c1">#set GRUB to default boot to install kernel</span>
<span class="nv">$sudo</span> vi /etc/default/grub
<span class="c1">#change GRUB_DEFAULT line like below to default to</span>
<span class="nv">GRUB_DEFAULT</span><span class="o">=</span><span class="s1">&#39;Advanced options for Ubuntu&gt;Ubuntu, with Linux 5.4.170-lts2019-iotg&#39;</span>

<span class="c1">#Ubdate GRUB to take in above changes</span>
$ sudo update-grub
$ sudo reboot now
</pre></div>
</div>
<ul class="simple">
<li>After reboot completes, select to use IOTG kernel release in Ubuntu menu as per build kernel instructions</li>
</ul>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Check kernel id after reboot</span>
$ uname -r
<span class="m">5</span>.4.170-lts2019-iotg
</pre></div>
</div>
</div>
<div class="section" id="run-celadon-host-setup">
<h2>Run Celadon host setup</h2>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Prepare setup_host.sh</span>
$ chmod +x ./scripts/setup_host.sh
<span class="c1"># Update the host</span>
<span class="c1"># If prompted, answer y to go ahead with changes</span>
<span class="c1"># Note: CiV guest autostart service could also be auto created during setup</span>
  <span class="o">(</span>details see section <span class="s2">&quot;Auto start of CiV&quot;</span><span class="o">)</span>
<span class="c1"># Setup option 1 example:</span>
<span class="c1"># GVT-d setup without CIV guest autostart service creation</span>
$ sudo -E ./scripts/setup_host.sh -u headless
<span class="c1"># Setup option 2 example:</span>
<span class="c1"># GVT-d setup with CIV autostart service with desired CiV guest startup options.</span>
$ sudo -E ./scripts/setup_host.sh -u headless --auto-start <span class="s2">&quot;-m 4G -c 4 -g GVT-d --passthrough-pci-usb --passthrough-pci-wifi --battery-mediation --passthrough-pwr-vol-button --guest-pm-control --guest-time-keep --allow-suspend&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="guest-os-setup">
<h2>Guest OS setup:</h2>
<div class="section" id="creating-celadon-guest-image">
<span id="creating"></span><h3>Creating Celadon guest image</h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This needs to be done at least once on a properly setup Ubuntu host to create the guest image for testing.</p>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Change directory</span>
$ <span class="nb">cd</span> ~

<span class="c1"># Generate Celadon guest image from caas-flashfiles.</span>
<span class="c1"># the script and flashfiles have already been extracted from caas-releasefiles-userdebug.tar.gz earlier</span>
<span class="c1"># wait for &quot;Flashing is completed&quot; msg from script.</span>
$ sudo -E ./scripts/start_flash_usb.sh caas-flashfiles-xxxxx.zip --display-off

<span class="c1"># Note:</span>
<span class="c1"># if you want to flash guest image to dedicated partition (required for using Android secure data erase feature).</span>
<span class="c1"># please use below command where partition is the partition device name. Eg. /dev/sda3</span>
$ sudo -E ./scripts/start_flash_usb.sh caas-flashfiles-xxxxx.zip -d &lt;partition&gt; --display-off
</pre></div>
</div>
</div>
<div class="section" id="launching-celadon-with-gvt-d">
<span id="launch"></span><h3>Launching Celadon with GVT-d</h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">As this is a GVT-d setup, the host display will be replaced by the Android screen.Therefore it is necessary to establish a SSH connection to host first, and then launch CIV from the SSH console.</p>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Before launching CIV, Ubuntu host must be in console login for GVT-d</span>
<span class="c1"># If you see that Ubuntu host has booted up into graphical login, perform the following to reboot to console login.</span>
<span class="c1"># Otherwise you can skip this step</span>
$ sudo systemctl set-default multi-user.target
$ sudo reboot now

<span class="c1"># If already in console login, run the script to start CIV in GVT-d mode</span>
<span class="c1"># the script start_civ.sh has already been extracted from caas-releasefiles-userdebug.tar.gz earlier</span>
$ <span class="nb">cd</span> ~
$ sudo -E ./scripts/start_civ.sh -g GVT-d

<span class="c1"># if you want to boot guest image flashed in dedicated partition (required for using Android secure data erase feature).</span>
<span class="c1"># please use below command where &lt;partition&gt; is the guest image partition device name. Eg. /dev/sda3</span>
$ sudo -E ./scripts/start_civ.sh -g GVT-d -d &lt;partition&gt;
</pre></div>
</div>
<p>To debug the guest, connect to the guest console from another shell:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Connect to Celadon guest console.</span>
$ <span class="nb">cd</span> ~
$ sudo socat unix-connect:./kernel-console stdio
</pre></div>
</div>
</div>
</div>
<div class="section" id="enable-keyboard-and-mouse">
<h2>Enable keyboard and mouse</h2>
<p>You can enable a keyboard and mouse either via USB host passthrough option or add
the extend command to <code class="docutils literal"><span class="pre">start_civ.sh</span></code>. Via add extend command parameter of
<code class="docutils literal"><span class="pre">start_civ.sh</span></code> to pass through selective devices</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Retrieve the vendorid and productid</span>
<span class="c1"># In this example, 046d is vendor id, c06a is product id</span>
$ lsusb

<span class="c1"># Bus 004 Device 003: ID 046d:c06a Logitech, Inc. USB Optical Mouse</span>
<span class="c1"># Add extend command when start guest</span>
$ sudo -E ./scripts/start_civ.sh -g GVT-d -e <span class="s2">&quot;-device usb-host,vendorid=0x046d,productid=0xc06a&quot;</span>
</pre></div>
</div>
<p>Via USB host passthrough parameter of <code class="docutils literal"><span class="pre">start_civ.sh</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Note: all connected USB devices will be passthrough to Android with USB host passthrough option</span>
$ sudo -E ./scripts/start_civ.sh -g GVT-d --passthrough-pci-usb
</pre></div>
</div>
<p>Change guest VM memory and number of CPUs:
The default script is setup for 1 cpu and 2G ram when no addition memory/cpu
options specified. Below example shows guest start configuration for 4 cores,
4G ram.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Add -m option to specify 4G of memory</span>
<span class="c1"># Add -c option to specify 4 cpu cores for guest VM</span>
$ sudo -E ./scripts/start_civ.sh -m 4G -c <span class="m">4</span> -g GVT-d
</pre></div>
</div>
<p>Optional: Below is a sample script for providing maximum ram and number of cpu
settings to guest VM automatically based on hardware platform available if so
desired.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Change to auto detect and configure max ram and cpu for guest based on hardware platform</span>
$ sudo -E ./scripts/start_civ.sh -m <span class="k">$(($(</span>free -m <span class="p">|</span> awk <span class="s1">&#39;{ if ($1 == &quot;Mem:&quot;) { print $2 }}&#39;</span><span class="k">)</span><span class="o">-</span><span class="m">2048</span><span class="k">))</span>M -c <span class="k">$(</span>nproc --all<span class="k">)</span> -g GVT-d
</pre></div>
</div>
<p>Device passthrough options for launching CiV (Passthrough Device features)</p>
<ul class="simple">
<li>GPU host partition USB host wifi audio power and volume buttons BT
ethernet thermal battery sd card partition <code class="docutils literal"><span class="pre">/dev/mmcblk0p1</span></code></li>
<li>Validate Comet Lake (CML), Tiger Lake (TGL), and Elkhart Lake (EHL)
platforms passthrough command:</li>
</ul>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sudo -E ./scripts/start_civ.sh -m 4G -c <span class="m">4</span> -g GVT-d -d /dev/sdXX --passthrough-pci-usb --passthrough-pci-wifi --passthrough-pci-audio --passthrough-pwr-vol-button --battery-mediation --thermal-mediation --guest-pm-control --guest-time-keep --external-wakeup-mode --allow-suspend -b /dev/mmcblk0p1
</pre></div>
</div>
<ol class="arabic simple">
<li>The guest image must be created with a dedicated host partition by using the
<code class="docutils literal"><span class="pre">-d</span> <span class="pre">&lt;guest-image</span> <span class="pre">partition</span> <span class="pre">device&gt;</span></code> option, where
&lt;guest-image partition device&gt; is the block partition device name such
as <code class="docutils literal"><span class="pre">/dev/sda3</span></code>. See earlier sections <a class="reference internal" href="#creating-celadon-guest-image">Creating Celadon guest image</a>  and
<a class="reference internal" href="#launching-celadon-with-gvt-d">Launching Celadon with GVT-d</a>  for required
setup. This setup is required to enable support for Android secure data erase
feature. When the <code class="docutils literal"><span class="pre">-d</span> <span class="pre">&lt;partition&gt;</span></code> option is used with <code class="docutils literal"><span class="pre">start_civ.sh</span></code>,
the host side utility <code class="docutils literal"><span class="pre">secure_erase_daemon</span></code> will also be run. This daemon
performs secure erase of the userdata section in the host partition during
Android wipe data process triggered by factory reset or recovery wipe data
operations. The Recovery UI/recovery.log will show “SECURE ERASE SUCCESS” upon
success or “Secure Erase failed, format directly” on failure if secure erase of
partition is not supported by hardware block device.</li>
<li>The <code class="docutils literal"><span class="pre">--passthrough-pci-usb</span> <span class="pre">USB</span></code> host passthrough also passes through the
BT adapter connected via USB.</li>
<li>Ethernet lan is in same IOMMU group as audio for CML/EHL/TGL, so when using
the <code class="docutils literal"><span class="pre">--passthrough-pci-audio</span></code> host lan will not be usable since lan is passed
through also automatically.</li>
<li>An SD card must be inserted before starting the Android guest for the SD card
mediation option <code class="docutils literal"><span class="pre">-b</span> <span class="pre">/dev/mmcblk0p1</span></code>.</li>
<li>The <code class="docutils literal"><span class="pre">--battery-mediation</span></code> option is required for battery mediation to VM.</li>
<li>The <code class="docutils literal"><span class="pre">--thermal-mediation</span></code> option is required for thermal mediation to VM.</li>
<li>The <code class="docutils literal"><span class="pre">--guest-pm-control</span></code> option is required for power management of the host
by the guest. Also refer to <a class="reference internal" href="#supplement"><span class="std std-ref">Supplementary guide for power and volume key support</span></a> for suspend/resume via power key.</li>
<li>The <code class="docutils literal"><span class="pre">--guest-time-keep</span></code> option is for synchronization of VM time settings
back to the host platform. Please ensure time synchronization services on
Ubuntu host have been disabled first when using this option, eg. via
<code class="docutils literal"><span class="pre">sudo</span> <span class="pre">timedatectl</span> <span class="pre">set-ntp</span> <span class="pre">off</span></code>. The <code class="docutils literal"><span class="pre">Guest</span> <span class="pre">RTC</span> <span class="pre">alarm</span> <span class="pre">sync</span> <span class="pre">to</span> <span class="pre">host</span></code> feature
is enabled by default when –guest-time-keep option is used. When used together
with –guest-pm-control, this feature will allow Android to set alarms to wake
the host (and Android guest) from suspend state upon alarm expiry. If you use
the –guest-time-keep and –guest-pm-control options, please also enable
the –external-wakeup-mode option. it will help to avoid synchronization issue
during suspend/resume.</li>
<li>The <code class="docutils literal"><span class="pre">--external-wakeup-mode</span></code> option is to disable Qemu internal timeout
alarm for suspend/resume and use host RTC timer instead. This option should
be used together with the <code class="docutils literal"><span class="pre">--guest-time-keep</span></code> and <code class="docutils literal"><span class="pre">--guest-pm-control</span></code>
options.</li>
<li>The <code class="docutils literal"><span class="pre">--passthrough-pwr-vol-button</span></code> option is for passing physical
hardware power and volume button press (if present) and virtual key presses
to VM via sendkey utility. See <a class="reference internal" href="#supplement"><span class="std std-ref">Supplementary guide for power and volume key support</span></a> for more details
on what is provided by this option.</li>
<li>The <code class="docutils literal"><span class="pre">--allow-suspend</span></code> option is for allowing Android to enter suspend when
idle.</li>
<li>In case the options <code class="docutils literal"><span class="pre">--passthrough-pci-usb</span></code>, <code class="docutils literal"><span class="pre">--passthrough-pci-wifi</span></code>,
and <code class="docutils literal"><span class="pre">--guest-pm-control</span></code> are all used together, as well as the
<code class="docutils literal"><span class="pre">Auto</span> <span class="pre">start</span> <span class="pre">of</span> <span class="pre">CiV</span></code> feature is enabled, we recommended to make the changes
shown below in the Host to make WiFi and Bluetooth to be more stable.</li>
</ol>
<ul class="simple">
<li>Add <code class="docutils literal"><span class="pre">GRUB_CMDLINE_LINUX=modprobe.blacklist=xhci_pci</span> <span class="pre">modprobe.blacklist=xhci_hcd</span> <span class="pre">modprobe.blacklist=iwlwifi</span></code> to <code class="docutils literal"><span class="pre">/etc/default/grub</span></code> file</li>
<li>Modify <code class="docutils literal"><span class="pre">start_civ.sh</span></code></li>
</ul>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># In function set_pt_wifi(), delete</span>
<span class="c1"># local WIFI_PCI=$(lshw -C network |grep -i &quot;description: wireless interface&quot; -A5 |grep &quot;bus info&quot; |grep -o &quot;....:..:....&quot;)</span>
<span class="c1"># Use below line instead</span>
<span class="c1"># local WIFI_PCI=$(lspci -D |grep -i -E &quot;Network controller.* Wireless|Network controller.* Wi-Fi&quot; | grep -o &quot;....:..:..\..&quot;)</span>
</pre></div>
</div>
</div>
<div class="section" id="auto-starting-civ-using-gvt-d">
<h2>Auto starting CiV (using GVT-d)</h2>
<p>The Android CiV guest can be made to start automatically as a service on host
system boot and be the default configuration after setup. One way to implement
this solution is shown below. Here it is assumed that CiV has been installed to
<code class="docutils literal"><span class="pre">/home/&lt;user&gt;</span></code> directory, where &lt;user&gt; is the ubuntu host username.
Modify ExecStart accordingly for the options desired for CiV guest startup.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ sudo vim /etc/systemd/system/civ.service

<span class="c1"># update file civ.service with below changes</span>
<span class="o">[</span>Unit<span class="o">]</span>
<span class="nv">Description</span><span class="o">=</span>CiV Auto Start

<span class="o">[</span>Service<span class="o">]</span>
<span class="nv">Type</span><span class="o">=</span>forking

<span class="nv">TimeoutSec</span><span class="o">=</span>infinity
<span class="nv">WorkingDirectory</span><span class="o">=</span>/home/&lt;user&gt;
<span class="nv">ExecStart</span><span class="o">=</span>/bin/bash -E /home/&lt;user&gt;/scripts/start_civ.sh -g GVT-d --passthrough-pci-usb --passthrough-pci-wifi --passthrough-pci-audio --passthrough-pwr-vol-button --battery-mediation --thermal-mediation --guest-pm-control --guest-time-keep --allow-suspend

<span class="o">[</span>Install<span class="o">]</span>
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target

<span class="c1"># Reload daemon and start civ service</span>
$ sudo systemctl daemon-reload
$ sudo systemctl start civ

<span class="c1"># Enable auto start of CiV at every reboot of host CPU</span>
$ sudo systemctl <span class="nb">enable</span> civ
</pre></div>
</div>
</div>
<div class="section" id="supplementary-guide-for-power-and-volume-key-support">
<span id="supplement"></span><h2>Supplementary guide for power and volume key support</h2>
<p>Power and volume key support for guest VM.</p>
<ol class="arabic simple">
<li>Start Android with pwr/vol button passthrough option</li>
</ol>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ sudo -E ./scripts/start_civ.sh -g GVT-d --passthrough-pwr-vol-button --allow-suspend
</pre></div>
</div>
<ol class="arabic simple">
<li>Send the following adb command to enable Developer options</li>
</ol>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ adb shell settings put global development_settings_enabled <span class="m">1</span>
</pre></div>
</div>
<ol class="arabic simple">
<li>Disable “Stay awake” setting within the Developer options (Settings -&gt; System -&gt; Developer options)</li>
<li>Use below commands to test set volume and power button at host or press physical buttons if present</li>
</ol>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Volume Functionality:</span>
./sendkey --vm <span class="m">0</span> --volume <span class="nv">up</span> <span class="o">=</span>&gt; Increases volume in CIV
./sendkey --vm <span class="m">0</span> --volume <span class="nv">down</span> <span class="o">=</span>&gt; decreases volume in CIV

<span class="c1"># Power Functionality:</span>
./sendkey --vm <span class="m">0</span> --power <span class="nv">0</span> <span class="o">=</span>&gt; Suspend/Resume in CIV
./sendkey --vm <span class="m">0</span> --power <span class="nv">5</span> <span class="o">=</span>&gt; long press of power key <span class="k">for</span> <span class="m">5</span> seconds. Displays power options in android.
</pre></div>
</div>
</div>
<div class="section" id="acronyms-and-terms">
<h2>Acronyms and terms</h2>
<ul class="simple">
<li>Stable Releases (IoT) - IOTG overlay on top of Celadon</li>
<li>CIV - Celadon in Virtual Machine</li>
<li>CML: COMET LAKE</li>
<li>TGL: TIGER LAKE</li>
<li>EHL: ELKHART LAKE</li>
<li>GVT-d : Intel® Graphics Virtualization Technology -g (Intel® GVT-g): virtual
graphics processing unit (vGPU) (multiple VMs to one physical GPU)</li>
</ul>
</div>
<div class="section" id="helpful-hints-related-documents">
<h2>Helpful hints / related documents</h2>
<ul class="simple">
<li>If you plan to use Celadon in a product, please replace all the test keys
under <code class="docutils literal"><span class="pre">device/intel/build/testkeys/</span></code> with your product key</li>
<li>The release of this project will be signed by test keys; it’s only a
reference for our customer and we are not responsible for this. Customers
should use their own keys to sign their release images</li>
<li>Build Celadon in VM  <a class="reference external" href="https://01.org/projectceladon/documentation/getting-started/build-source#build-os-image">https://01.org/projectceladon/documentation/getting-started/build-source#build-os-image</a></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../release-notes.html" class="btn btn-neutral float-right" title="Release Notes" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="feature-delta-iot.html" class="btn btn-neutral" title="Feature Delta Offered by Stable Releases (IoT)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, BSD, MIT, Apache and GPL licenses.
      Last updated on Nov 07, 2022.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 

</body>
</html>